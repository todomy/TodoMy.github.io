name: build Gmeek  # å®šä¹‰å·¥ä½œæµçš„åç§°

on:  # æŒ‡å®šè§¦å‘å·¥ä½œæµçš„äº‹ä»¶
  workflow_dispatch:  # å½“æœ‰äººæ‰‹åŠ¨è§¦å‘æ—¶
  issues:  # å½“æœ‰æ–°çš„issueæˆ–issueè¢«ç¼–è¾‘æ—¶
    types: [opened, edited, closed, reopened]
  # schedule:  # è®¡åˆ’ä»»åŠ¡ï¼ˆå·²æ³¨é‡Šï¼Œæš‚æ—¶ä¸å¯ç”¨ï¼‰
  #   - cron: "0 0 * * *"  # æ¯å¤©çš„00:00 UTCæ—¶é—´è§¦å‘
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'

jobs:  # å®šä¹‰å·¥ä½œæµä¸­çš„å·¥ä½œï¼ˆjobsï¼‰
  build:  # å®šä¹‰åä¸ºâ€œbuildâ€çš„å·¥ä½œ
    name: Generate blog  # å·¥ä½œçš„åå­—
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„Ubuntuç‰ˆæœ¬ä»¥ç¡®ä¿é•¿æœŸæ”¯æŒ
    # ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨çŸ©é˜µç­–ç•¥æ¥æµ‹è¯•å¤šä¸ªUbuntuç‰ˆæœ¬:
    # strategy:
    #   matrix:
    #     os: [ubuntu-latest, ubuntu-22.04]
    # ç„¶åå¼•ç”¨${{ matrix.os }}ä½œä¸ºruns-onå€¼
    if: ${{ github.event.repository.owner.id == github.event.sender.id || github.event_name == 'schedule' }}  # æ¡ä»¶åˆ¤æ–­ï¼Œç¡®ä¿åªæœ‰ä»“åº“æ‰€æœ‰è€…æˆ–è®¡åˆ’ä»»åŠ¡è§¦å‘æ—¶æ‰æ‰§è¡Œ
    permissions: write-all  # è®¾ç½®æƒé™ï¼Œå…è®¸å†™å…¥æ‰€æœ‰å†…å®¹
    steps:  # å·¥ä½œçš„å…·ä½“æ­¥éª¤
      - name: Checkout  # æ­¥éª¤åç§°ï¼šæ£€å‡ºä»£ç 
        uses: actions/checkout@v4  # ä½¿ç”¨actionsæä¾›çš„æ£€å‡ºä»£ç æ“ä½œ
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿æ›´å¥½åœ°è·Ÿè¸ªå˜åŒ–

      - name: Setup Pages  # æ­¥éª¤åç§°ï¼šè®¾ç½®Pages
        id: pages  # æ­¥éª¤æ ‡è¯†ï¼Œç”¨äºåç»­å¼•ç”¨è¾“å‡º
        uses: actions/configure-pages@v4  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬çš„Pagesè®¾ç½®æ“ä½œ
        with:
          static_site_generator: none  # ä¸ä½¿ç”¨é»˜è®¤çš„é™æ€ç«™ç‚¹ç”Ÿæˆå™¨
          # ä¸æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œç›´æ¥éƒ¨ç½²é™æ€å†…å®¹

      - name: Get config.json  # æ­¥éª¤åç§°ï¼šè·å–config.jsoné…ç½®æ–‡ä»¶
        run: |
          echo "====== check config.json file ======"
          cat config.json  # æ‰“å°config.jsonæ–‡ä»¶å†…å®¹ï¼Œç”¨äºæ£€æŸ¥
          echo "====== check config.json end  ======"
          sudo apt-get install jq  # å®‰è£…jqå·¥å…·ï¼Œç”¨äºå¤„ç†JSON

      - name: Set up Python  # æ­¥éª¤åç§°ï¼šè®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5  # ä½¿ç”¨actionsæä¾›çš„Pythonè®¾ç½®æ“ä½œ
        with:
          python-version: 3.8  # æŒ‡å®šPythonç‰ˆæœ¬

      - name: Cache Python dependencies  # æ·»åŠ ä¾èµ–ç¼“å­˜
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies  # æ­¥éª¤åç§°ï¼šå®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip  # æ›´æ–°pipåˆ°æœ€æ–°ç‰ˆæœ¬
          pip install -r requirements.txt  # å®‰è£…requirements.txtä¸­åˆ—å‡ºçš„ä¾èµ–

      - name: Generate new html  # æ­¥éª¤åç§°ï¼šç”Ÿæˆæ–°çš„HTMLæ–‡ä»¶
        run: |
          echo "å¼€å§‹ç”ŸæˆHTMLæ–‡ä»¶..."
          python Gmeek.py ${{ secrets.GITHUB_TOKEN }} ${{ github.repository }} --issue_number '${{ github.event.issue.number }}' 2>&1 || echo "è­¦å‘Š: æ„å»ºè¿‡ç¨‹ä¸­å¯èƒ½æœ‰éå…³é”®é”™è¯¯ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          echo "HTMLæ–‡ä»¶ç”Ÿæˆå®Œæˆ"

      - name: Update html  # æ­¥éª¤åç§°ï¼šæ›´æ–°HTMLæ–‡ä»¶
        run: |
          git config --local user.email "$(jq -r ".email" config.json)"  # è®¾ç½®gitç”¨æˆ·é‚®ç®±
          git config --local user.name "${{ github.repository_owner }}"  # è®¾ç½®gitç”¨æˆ·å
          # åªæ·»åŠ å¿…è¦çš„æ–‡ä»¶ï¼Œé¿å…æ„å¤–æäº¤
          git add docs/ README.md || echo "æ²¡æœ‰éœ€è¦æ·»åŠ çš„æ–‡ä»¶"
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          else
            git commit -m 'ğŸ‰auto update by Gmeek action'
            echo "æ­£åœ¨æ¨é€æ›´æ”¹..."
            git push origin main
            echo "æ¨é€å®Œæˆ"
          fi
          # ç§»é™¤sleepï¼Œå› ä¸ºGitæ“ä½œå·²å®Œæˆ

      - name: Upload artifact  # æ­¥éª¤åç§°ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3  # ä½¿ç”¨actionsæä¾›çš„é¡µé¢æ„å»ºäº§ç‰©ä¸Šä¼ æ“ä½œ
        with:
          path: 'docs/'  # æŒ‡å®šä¸Šä¼ è·¯å¾„ä¸ºdocsç›®å½•

  deploy:  # å®šä¹‰åä¸ºâ€œdeployâ€çš„å·¥ä½œ
    name: Deploy blog  # å·¥ä½œçš„åå­—
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„Ubuntuç‰ˆæœ¬ä»¥ç¡®ä¿é•¿æœŸæ”¯æŒ
    needs: build  # æŒ‡å®šä¾èµ–çš„å·¥ä½œä¸ºâ€œbuildâ€
    permissions:  # è®¾ç½®æƒé™
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
      pages: write  # å…è®¸å†™å…¥Pages
      id-token: write  # å…è®¸å†™å…¥èº«ä»½ä»¤ç‰Œ
    concurrency:  # è®¾ç½®å¹¶å‘ç­–ç•¥
      group: "pages"  # å¹¶å‘ç»„ä¸ºâ€œpagesâ€
      cancel-in-progress: false  # å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å¹¶å‘å·¥ä½œ
    environment:  # è®¾ç½®ç¯å¢ƒå˜é‡
      name: github-pages  # ç¯å¢ƒåä¸ºgithub-pages
      url: ${{ steps.deployment.outputs.page_url }}  # é¡µé¢URLæ¥è‡ªéƒ¨ç½²æ­¥éª¤çš„è¾“å‡º
    steps:  # å·¥ä½œçš„å…·ä½“æ­¥éª¤
      - name: Deploy to GitHub Pages  # æ­¥éª¤åç§°ï¼šéƒ¨ç½²åˆ°GitHub Pages
        id: deployment  # æ­¥éª¤æ ‡è¯†
        uses: actions/deploy-pages@v4  # ä½¿ç”¨actionsæä¾›çš„Pageséƒ¨ç½²æ“ä½œ
