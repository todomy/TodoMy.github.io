name: build Gmeek  # å®šä¹‰å·¥ä½œæµçš„åç§°

on:  # æŒ‡å®šè§¦å‘å·¥ä½œæµçš„äº‹ä»¶
  workflow_dispatch:  # å½“æœ‰äººæ‰‹åŠ¨è§¦å‘æ—¶
  issues:  # å½“æœ‰æ–°çš„issueæˆ–issueè¢«ç¼–è¾‘æ—¶
    types: [opened, edited]  # æŒ‡å®šè§¦å‘äº‹ä»¶çš„ç±»å‹
  schedule:  # è®¡åˆ’ä»»åŠ¡
    - cron: "0 0 * * *"  # æ¯å¤©çš„00:00 UTCæ—¶é—´è§¦å‘

jobs:  # å®šä¹‰å·¥ä½œæµä¸­çš„å·¥ä½œï¼ˆjobsï¼‰
  build:  # å®šä¹‰åä¸ºâ€œbuildâ€çš„å·¥ä½œ
    name: Generate blog  # å·¥ä½œçš„åå­—
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„Ubuntuç‰ˆæœ¬ï¼Œç¡®ä¿é•¿æœŸå…¼å®¹æ€§
    if: ${{ github.event.repository.owner.id == github.event.sender.id || github.event_name == 'schedule' }}  # æ¡ä»¶åˆ¤æ–­ï¼Œç¡®ä¿åªæœ‰ä»“åº“æ‰€æœ‰è€…æˆ–è®¡åˆ’ä»»åŠ¡è§¦å‘æ—¶æ‰æ‰§è¡Œ
    permissions: write-all  # è®¾ç½®æƒé™ï¼Œå…è®¸å†™å…¥æ‰€æœ‰å†…å®¹
    steps:  # å·¥ä½œçš„å…·ä½“æ­¥éª¤
      - name: Checkout  # æ­¥éª¤åç§°ï¼šæ£€å‡ºä»£ç 
        uses: actions/checkout@v4  # ä½¿ç”¨actionsæä¾›çš„æ£€å‡ºä»£ç æ“ä½œ

      - name: Setup Pages  # æ­¥éª¤åç§°ï¼šè®¾ç½®Pages
        id: pages  # æ­¥éª¤æ ‡è¯†ï¼Œç”¨äºåç»­å¼•ç”¨è¾“å‡º
        uses: actions/configure-pages@v4  # ä½¿ç”¨actionsæä¾›çš„Pagesè®¾ç½®æ“ä½œ

      - name: Get config.json  # æ­¥éª¤åç§°ï¼šè·å–config.jsoné…ç½®æ–‡ä»¶
        run: |
          echo "====== check config.json file ======"
          cat config.json  # æ‰“å°config.jsonæ–‡ä»¶å†…å®¹ï¼Œç”¨äºæ£€æŸ¥
          echo "====== check config.json end  ======"
          sudo apt-get install jq  # å®‰è£…jqå·¥å…·ï¼Œç”¨äºå¤„ç†JSON

      - name: Set up Python  # æ­¥éª¤åç§°ï¼šè®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5  # ä½¿ç”¨actionsæä¾›çš„Pythonè®¾ç½®æ“ä½œ
        with:
          python-version: 3.8  # æŒ‡å®šPythonç‰ˆæœ¬

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies  # æ­¥éª¤åç§°ï¼šå®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip  # æ›´æ–°pipåˆ°æœ€æ–°ç‰ˆæœ¬
          pip install -r requirements.txt  # å®‰è£…requirements.txtä¸­åˆ—å‡ºçš„ä¾èµ–

      - name: Generate new html  # æ­¥éª¤åç§°ï¼šç”Ÿæˆæ–°çš„HTMLæ–‡ä»¶
        run: |
          python Gmeek.py ${{ secrets.GITHUB_TOKEN }} ${{ github.repository }} --issue_number '${{ github.event.issue.number }}'  # è¿è¡ŒGmeek.pyè„šæœ¬ç”ŸæˆHTML
          # Gmeek.pyåº”è¯¥åœ¨${{ github.workspace }}ç›®å½•ä¸‹è¿è¡Œå¹¶ç”Ÿæˆæ‰€éœ€çš„æ–‡ä»¶

      - name: Update html  # æ­¥éª¤åç§°ï¼šæ›´æ–°HTMLæ–‡ä»¶
        run: |
          git config --local user.email "$(jq -r ".email // 'actions@github.com'" config.json)"  # è®¾ç½®gitç”¨æˆ·é‚®ç®±
          git config --local user.name "${{ github.repository_owner }}"  # è®¾ç½®gitç”¨æˆ·å
          git add docs/ postList.json blogBase.json  # åªæ·»åŠ éœ€è¦çš„æ–‡ä»¶ï¼Œæé«˜æ•ˆç‡
          git add README.md || true  # å°è¯•æ·»åŠ README.mdï¼Œä½†ä¸å¤±è´¥
          git commit -a -m 'ğŸ‰auto update by Gmeek action' || echo "nothing to commit"  # æäº¤æ›´æ”¹æˆ–æ‰“å°æ— æäº¤ä¿¡æ¯
          git push || echo "nothing to push"  # æ¨é€æ›´æ”¹æˆ–æ‰“å°æ— æ¨é€ä¿¡æ¯

      - name: Upload artifact  # æ­¥éª¤åç§°ï¼šä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-pages-artifact@v3  # ä½¿ç”¨actionsæä¾›çš„é¡µé¢æ„å»ºäº§ç‰©ä¸Šä¼ æ“ä½œ
        with:
          path: 'docs/'  # æŒ‡å®šä¸Šä¼ è·¯å¾„ä¸ºdocsç›®å½•

  deploy:  # å®šä¹‰åä¸ºâ€œdeployâ€çš„å·¥ä½œ
    name: Deploy blog  # å·¥ä½œçš„åå­—
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒ
    needs: build  # æŒ‡å®šä¾èµ–çš„å·¥ä½œä¸ºâ€œbuildâ€
    permissions:  # è®¾ç½®æƒé™
      contents: write  # å…è®¸å†™å…¥ä»“åº“å†…å®¹
      pages: write  # å…è®¸å†™å…¥Pages
      id-token: write  # å…è®¸å†™å…¥èº«ä»½ä»¤ç‰Œ
    concurrency:  # è®¾ç½®å¹¶å‘ç­–ç•¥
      group: "pages"  # å¹¶å‘ç»„ä¸ºâ€œpagesâ€
      cancel-in-progress: false  # å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å¹¶å‘å·¥ä½œ
    environment:  # è®¾ç½®ç¯å¢ƒå˜é‡
      name: github-pages  # ç¯å¢ƒåä¸ºgithub-pages
      url: ${{ steps.deployment.outputs.page_url }}  # é¡µé¢URLæ¥è‡ªéƒ¨ç½²æ­¥éª¤çš„è¾“å‡º
    steps:  # å·¥ä½œçš„å…·ä½“æ­¥éª¤
      - name: Deploy to GitHub Pages  # æ­¥éª¤åç§°ï¼šéƒ¨ç½²åˆ°GitHub Pages
        id: deployment  # æ­¥éª¤æ ‡è¯†
        uses: actions/deploy-pages@v4  # ä½¿ç”¨actionsæä¾›çš„Pageséƒ¨ç½²æ“ä½œ
